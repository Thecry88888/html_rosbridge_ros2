<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="/node_modules/roslib/importmap.js"></script>

    <script type="module">
      import * as ROSLIB from "roslib";
      // Connecting to ROS
      // -----------------
      var ros = new ROSLIB.Ros({
        url: "ws://localhost:9090",
      });

      // If there is an error on the backend, an 'error' emit will be emitted.
      ros.on("error", function (error) {
        document.getElementById("connecting").style.display = "none";
        document.getElementById("connected").style.display = "none";
        document.getElementById("closed").style.display = "none";
        document.getElementById("error").style.display = "inline";
        console.log(error);
      });

      // Find out exactly when we made a connection.
      ros.on("connection", function () {
        console.log("Connection made!");
        document.getElementById("connecting").style.display = "none";
        document.getElementById("error").style.display = "none";
        document.getElementById("closed").style.display = "none";
        document.getElementById("connected").style.display = "inline";
      });

      ros.on("close", function () {
        console.log("Connection closed.");
        document.getElementById("connecting").style.display = "none";
        document.getElementById("connected").style.display = "none";
        document.getElementById("closed").style.display = "inline";
      });

      // The ActionClient
      // ----------------

      var taskClient = new ROSLIB.Action({
        ros: ros,
        name: "task_one",
        actionType: "robot_interfaces/action/Task",
      });

      var armAttitudeMessage = {
        x: 1.0,
        y: 0.5,
        z: 0.2,
        w: 0.0,
        p: 0.0,
        r: 0.0,
        t: 0.0
      };

      var goalMessage = {
        // 字段名稱 'attitude' 必須與 Task.action 檔中 Request 區塊的定義完全一致
        attitude: armAttitudeMessage
      };

      // Send an action goal
      var goal_id = taskClient.sendGoal(
        goalMessage,
        function (result) {
          console.log("--- action result ---");
          console.log("任務執行結果: " + (result.success ? "成功" : "失敗"));
          console.log("-----------------------");
        },

        function (feedback) {
          console.log("--- action feedback ---");
          console.log("當前步驟: " + feedback.current_step);
          console.log("-------------------------");
        },

        // 失敗回調 (Failed Callback)
        function (error) {
          console.error("動作執行失敗或超時:", error);
        }
      );
      console.log("已發送目標 ID:", goal_id);
    </script>
  </head>

  <body>
    <h1>Task Action Client</h1>
    <p>
      Run the following commands in the terminal then refresh this page. Check
      the JavaScript console for the output.
    </p>
    <ol>
      <li>
        <tt>ros2 launch rosbridge_server rosbridge_websocket_launch.xml</tt>
      </li>
      <li><tt>ros2 launch strategy strategy.launch.py </tt></li>
    </ol>
    <div id="statusIndicator">
      <p id="connecting">Connecting to rosbridge...</p>
      <p id="connected" style="color: #00d600; display: none">Connected</p>
      <p id="error" style="color: #ff0000; display: none">
        Error in the backend!
      </p>
      <p id="closed" style="display: none">Connection closed.</p>
    </div>
  </body>
</html>
